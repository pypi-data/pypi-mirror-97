.\" Man page generated from reStructuredText.
.
.TH "DEBOPS.NTP" "5" "Mar 03, 2021" "v2.0.8" "DebOps"
.SH NAME
debops.ntp \- Manage timezone and NTP client/server
.
.nr rst2man-indent-level 0
.
.de1 rstReportMargin
\\$1 \\n[an-margin]
level \\n[rst2man-indent-level]
level margin: \\n[rst2man-indent\\n[rst2man-indent-level]]
-
\\n[rst2man-indent0]
\\n[rst2man-indent1]
\\n[rst2man-indent2]
..
.de1 INDENT
.\" .rstReportMargin pre:
. RS \\$1
. nr rst2man-indent\\n[rst2man-indent-level] \\n[an-margin]
. nr rst2man-indent-level +1
.\" .rstReportMargin post:
..
.de UNINDENT
. RE
.\" indent \\n[an-margin]
.\" old: \\n[rst2man-indent\\n[rst2man-indent-level]]
.nr rst2man-indent-level -1
.\" new: \\n[rst2man-indent\\n[rst2man-indent-level]]
.in \\n[rst2man-indent\\n[rst2man-indent-level]]u
..
.sp
An NTP daemon is used for time synchronization, either on a local system as
a client, or on remote systems as a server.
.sp
The \fBdebops.ntp\fP Ansible role supports multiple NTP servers, and is
container\-aware so that an NTP server won\(aqt be installed inside containers.
.sp
The role is also used to configure the system timezone using the \fBtzdata\fP
package.
.SH GETTING STARTED
.SS OpenNTPD, ifupdown and systemd integration
.sp
The \fBopenntpd\fP Debian package provides an \fBifupdown\fP hook,
\fB/etc/network/if\-up.d/openntpd\fP\&. It\(aqs used to restart the NTP daemon on
any network interface changes so that it can re\-bind itself properly.
.sp
Unfortunately, the hook is not \fBsystemd\fP\-aware and this causes several
problems:
.INDENT 0.0
.IP \(bu 2
During boot, when \fBifupdown\fP configures each interface,
\fBsystemd\fP is forced to restart the \fBopenntpd\fP service early each
time. This might cause dependency problems and leave the NTP daemon service
in a failed state.
.IP \(bu 2
During \fBifupdown\fP interface reconfiguration, especially when
multiple interfaces are created or destroyed, the \fBopenntpd\fP service is
restarted multiple times in rapid succession. This might result in the
\fBsystemd\fP not starting the service when it hits the rate limits and
leaving it in a failed state.
.UNINDENT
.sp
To fix these issues, \fBdebops.ntp\fP role will divert the original \fBopenntpd\fP
hook and create its own, which is \fBsystemd\fP\-aware. The hook will only
restart the \fBopenntpd\fP service if it\(aqs already running, and will queue the
restart command in the background which should ensure that during interface
configuration NTP daemon is restarted only once, or just a few times and won\(aqt
hit rate limits. On boot, the NTP daemon will be started after network
configuration has been completed.
.SS Example inventory
.sp
\fBdebops.ntp\fP is included by default in the \fBcommon.yml\fP DebOps playbook;
you don\(aqt need to do anything to have it executed.
.SS Example playbook
.sp
Here\(aqs an example playbook for using the role without the DebOps playbook:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
\-\-\-

\- name: Manage Network Time Protocol service
  collections: [ \(aqdebops.debops\(aq, \(aqdebops.roles01\(aq,
                 \(aqdebops.roles02\(aq, \(aqdebops.roles03\(aq ]
  hosts: [ \(aqdebops_all_hosts\(aq, \(aqdebops_service_ntp\(aq ]
  become: True

  environment: \(aq{{ inventory__environment | d({})
                   | combine(inventory__group_environment | d({}))
                   | combine(inventory__host_environment  | d({})) }}\(aq

  roles:

    \- role: ferm
      tags: [ \(aqrole::ferm\(aq, \(aqskip::ferm\(aq ]
      ferm__dependent_rules:
        \- \(aq{{ ntp__ferm__dependent_rules }}\(aq

    \- role: ntp
      tags: [ \(aqrole::ntp\(aq, \(aqskip::ntp\(aq ]

.ft P
.fi
.UNINDENT
.UNINDENT
.SH AUTHOR
Maciej Delmanowski, Robin Schneider
.SH COPYRIGHT
2014-2021, Maciej Delmanowski, Nick Janetakis, Robin Schneider and others
.\" Generated by docutils manpage writer.
.
