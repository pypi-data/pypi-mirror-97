.\" Man page generated from reStructuredText.
.
.TH "DEBOPS.POSTCONF" "5" "Mar 03, 2021" "v2.1.4" "DebOps"
.SH NAME
debops.postconf \- Configure Postfix using Ansible via debops.postfix
.
.nr rst2man-indent-level 0
.
.de1 rstReportMargin
\\$1 \\n[an-margin]
level \\n[rst2man-indent-level]
level margin: \\n[rst2man-indent\\n[rst2man-indent-level]]
-
\\n[rst2man-indent0]
\\n[rst2man-indent1]
\\n[rst2man-indent2]
..
.de1 INDENT
.\" .rstReportMargin pre:
. RS \\$1
. nr rst2man-indent\\n[rst2man-indent-level] \\n[an-margin]
. nr rst2man-indent-level +1
.\" .rstReportMargin post:
..
.de UNINDENT
. RE
.\" indent \\n[an-margin]
.\" old: \\n[rst2man-indent\\n[rst2man-indent-level]]
.nr rst2man-indent-level -1
.\" new: \\n[rst2man-indent\\n[rst2man-indent-level]]
.in \\n[rst2man-indent\\n[rst2man-indent-level]]u
..
.SH SYNOPSIS
.sp
\fBdebops service/postconf\fP [\fB\-\-limit\fP \fIgroup,host,\fP\&...] [\fB\-\-diff\fP] [\fB\-\-check\fP] [\fB\-\-tags\fP \fItag1,tag2,\fP\&...] [\fB\-\-skip\-tags\fP \fItag1,tag2,\fP\&...] [<\fBansible\-playbook\fP options>] ...
.SH DESCRIPTION
.sp
The \fBdebops.postconf\fP Ansible role configures Postfix SMTP server according
to autodetected or manually selected parameters. The role uses the
debops.postfix Ansible role to manage Postfix configuration files and lookup
tables.
.SH GETTING STARTED
.SS Default configuration
.sp
This role provides a hopefully reasonable Postfix configuration for a SMTP
server on the public Internet. It does not configure Postfix directly; instead,
the configuration variables are passed to the debops.postfix Ansible role
which combines them with the other configuration specified by other Ansible
roles and generates the final Postfix configuration files. You should check the
debops.postfix documentation for explanation of how the configuration is
structured and what are the supported parameters.
.SS Postfix "capabilities"
.sp
To allow easier management of different configuration options, they are enabled
conditionally by "capabilities", a list of keywords either autogenerated by the
role conditionally, or set by the user in the Ansible inventory. The list is
inclusive; if you want to disable a particular autogenerated feature, you can
override the \fBpostconf__autodetect_capabilities\fP variable through
Ansible inventory.
.sp
Supported Postfix capabilities and their effects:
.INDENT 0.0
.TP
.B \fBauth\fP
Autodetected. Enabled, if role finds out Ansible local facts defined by the
\fBdebops.dovecot\fP or \fBdebops.saslauthd\fP Ansible roles, which indicates
that the SASL Auth facilities are available on the host.
.sp
This capability will enable SMTP authentication support via either Dovecot or
Cyrus SASL library, preferred in that order. The \fBsubmission\fP and \fBsmtps\fP
Postfix services will be enabled, with corresponding firewall configuration
that allows access from any host, by default.
.TP
.B \fBauthcleanup\fP
When enabled, the \fBsubmission\fP and \fBsmtps\fP Postfix services will check
the headers of incoming mail messages and apply filtering rules specified by
the \fB/etc/postfix/auth_header_checks.pcre\fP lookup table. This can be
used to sanitize authenticated mail messages before they are sent to the
external SMTP servers.
.TP
.B \fBdeprecated\fP
When enabled, the role will configure Postfix features and services that are
considered as deprecated.
.TP
.B \fBoverhead\fP
Enabled by default. Add a \fI\%custom header\fP <\fBhttp://www.gnuterrypratchett.com/\fP>
to every message that passes through this system.
.TP
.B \fBpublic\-mx\-required\fP
Autodetected. Enabled if a host has a public IPv4 or IPv6 address, with
assumption that the host will receive mail messages from public Internet
servers.
.sp
This capability will enable HELO and sender checks which will verify that
a given HELO domain or sender domain MX host has a public IP address.
Otherwise, mail messages directed to this MX won\(aqt be deliverable, therefore
it\(aqs better to reject the messages early.
.TP
.B \fBunauth\-sender\fP
Autodetected. Enabled by default when \fBauth\fP capability is enabled.
.sp
With this capability, Postfix will check the sender e\-mail addresses against
a list of its own domains. If any messages are sent from these domains
unauthenticated, they will be rejected.
.sp
With auhenticated mail, Postfix will check the sender address against the
mail user database defined in the \fBsmtpd_sender_login_maps\fP lookup tables.
If the sender address does not belong to the authenticated user, mail will be
rejected. This requires configuration of an user database, for example using
the debops.postldap role.
.UNINDENT
.SS Example inventory
.sp
To apply the Postfix configuration provided by the \fBdebops.postconf\fP role on
a host, it needs to be present in the \fB[debops_service_postconf]\fP Ansible
inventory group. You also need to enable debops.postfix support, as well as
any other additional roles that can be autodetected by \fBdebops.postconf\fP
role.
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
[debops_service_postfix]
hostname

[debops_service_postconf]
hostname

[debops_service_saslauthd]
hostname

[debops_service_dovecot]
hostname
.ft P
.fi
.UNINDENT
.UNINDENT
.SS Example playbook
.sp
If you are using this role without DebOps, here\(aqs an example Ansible playbook
that uses the \fBdebops.postconf\fP role:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
\-\-\-

\- name: Manage Postfix configuration
  collections: [ \(aqdebops.debops\(aq, \(aqdebops.roles01\(aq,
                 \(aqdebops.roles02\(aq, \(aqdebops.roles03\(aq ]
  hosts: [ \(aqdebops_service_postconf\(aq ]
  become: True

  environment: \(aq{{ inventory__environment | d({})
                   | combine(inventory__group_environment | d({}))
                   | combine(inventory__host_environment  | d({})) }}\(aq

  vars:

    secret__directories:
      \- \(aq{{ postfix__secret__directories }}\(aq

    ferm__dependent_rules:
      \- \(aq{{ postfix__ferm__dependent_rules }}\(aq

    postfix__dependent_packages:
      \- \(aq{{ postconf__postfix__dependent_packages }}\(aq

    postfix__dependent_maincf:
      \- role: \(aqpostconf\(aq
        config: \(aq{{ postconf__postfix__dependent_maincf }}\(aq
        state: \(aq{{ postconf__deploy_state }}\(aq

    postfix__dependent_mastercf:
      \- role: \(aqpostconf\(aq
        config: \(aq{{ postconf__postfix__dependent_mastercf }}\(aq
        state: \(aq{{ postconf__deploy_state }}\(aq

    postfix__dependent_lookup_tables:
      \- \(aq{{ postconf__postfix__dependent_lookup_tables }}\(aq

  pre_tasks:

    \- import_role:
        name: \(aqpostconf\(aq
        tasks_from: \(aqmain_env\(aq
      tags: [ \(aqrole::postconf\(aq, \(aqrole::postfix\(aq, \(aqrole::ferm\(aq ]

    \- import_role:
        name: \(aqpostfix\(aq
        tasks_from: \(aqmain_env\(aq
      tags: [ \(aqrole::postfix\(aq, \(aqrole::secret\(aq, \(aqrole::ferm\(aq ]

  roles:

    \- role: secret
      tags: [ \(aqrole::secret\(aq, \(aqrole::postfix\(aq ]

    \- role: ferm
      tags: [ \(aqrole::ferm\(aq, \(aqskip::ferm\(aq ]

    \- role: postfix
      tags: [ \(aqrole::postfix\(aq, \(aqskip::postfix\(aq ]

    \- role: postconf
      tags: [ \(aqrole::postconf\(aq, \(aqskip::postconf\(aq ]

.ft P
.fi
.UNINDENT
.UNINDENT
.SH AUTHOR
Maciej Delmanowski
.SH COPYRIGHT
2014-2021, Maciej Delmanowski, Nick Janetakis, Robin Schneider and others
.\" Generated by docutils manpage writer.
.
