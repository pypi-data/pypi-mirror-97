.\" Man page generated from reStructuredText.
.
.TH "DEBOPS.FILEBEAT" "5" "Mar 04, 2021" "v2.2.1" "DebOps"
.SH NAME
debops.filebeat \- Manage Filebeat service using Ansible
.
.nr rst2man-indent-level 0
.
.de1 rstReportMargin
\\$1 \\n[an-margin]
level \\n[rst2man-indent-level]
level margin: \\n[rst2man-indent\\n[rst2man-indent-level]]
-
\\n[rst2man-indent0]
\\n[rst2man-indent1]
\\n[rst2man-indent2]
..
.de1 INDENT
.\" .rstReportMargin pre:
. RS \\$1
. nr rst2man-indent\\n[rst2man-indent-level] \\n[an-margin]
. nr rst2man-indent-level +1
.\" .rstReportMargin post:
..
.de UNINDENT
. RE
.\" indent \\n[an-margin]
.\" old: \\n[rst2man-indent\\n[rst2man-indent-level]]
.nr rst2man-indent-level -1
.\" new: \\n[rst2man-indent\\n[rst2man-indent-level]]
.in \\n[rst2man-indent\\n[rst2man-indent-level]]u
..
.SH SYNOPSIS
.sp
\fBdebops service/filebeat\fP [\fB\-\-limit\fP \fIgroup,host,\fP\&...] [\fB\-\-diff\fP] [\fB\-\-check\fP] [\fB\-\-tags\fP \fItag1,tag2,\fP\&...] [\fB\-\-skip\-tags\fP \fItag1,tag2,\fP\&...] [<\fBansible\-playbook\fP options>] ...
.SH DESCRIPTION
.sp
\fI\%Filebeat\fP <\fBhttps://www.elastic.co/beats/filebeat\fP>, from \fI\%Elastic\fP <\fBhttps://www.elastic.co/\fP> is part of the Elastic Stack.
Filebeat can be used to parse and "ingest" logs from files,
syslog, and various other sources, parse them and send them off to
Elasticsearch, Logstash or other destinations.
.sp
The \fBfilebeat\fP Ansible role configures Filebeat on Debian/Ubuntu hosts. The
software itself will be installed using the debops.elastic_co Ansible
role.
.SH GETTING STARTED
.SS Default configuration
.sp
The \fBfilebeat\fP role includes a basic configuration for Filebeat which will by
default enable inputs for \fB/var/log/*.log\fP files, as well as the
\fBsystem\fP module. Several other Filebeat modules and input log configurations
will be enabled conditionally, based on the presence of various Ansible local
facts.
.sp
The role will also configure Filebeat to read input configuration from the
\fB/etc/filebeat/inputs.d/\fP directory, where other applications can add
their own configuration. The directory will not be created by default unless
configuration snippets placed in it are configured or enabled conditionally.
.sp
The default output is directed at an Elasticsearch database installed on the
same host as Filebeat. To change it, you can define in the Ansible inventory:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
filebeat__configuration:

  \- name: \(aqoutput_elasticsearch\(aq
    config:
      output.elasticsearch:
        hosts: [ \(aqelasticsearch.example.org:9200\(aq ]
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
See the filebeat__ref_configuration documentation for more details.
Elasticsearch database can be installed using the debops.elasticsearch
role.
.sp
Check the \fI\%Filebeat configuration\fP <\fBhttps://www.elastic.co/guide/en/beats/filebeat/current/configuring-howto-filebeat.html\fP> upstream documentation to learn more about
configuring Filebeat for your environment and requirements.
.SS Role debugging tips
.sp
Most of the configuration files generated by the role are protected by the
Ansible \fBno_log\fP keyword. To make debugging easier, you can use the
\fBdebops__no_log\fP variable in an inventory (in the development
environment) or with Ansible \fB\-\-extra\-vars\fP parameter (one time, for
production environment) to disable log protection. See the variable
documentation for more details.
.SS Example inventory
.sp
To install and configure Filebeat on a host, it needs to be included in the
\fB[debops_service_filebeat]\fP Ansible inventory group:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
[debops_all_hosts]
hostname

[debops_service_filebeat]
hostname
.ft P
.fi
.UNINDENT
.UNINDENT
.SS Example playbook
.sp
If you are using this role without DebOps, here\(aqs an example Ansible playbook
that uses the \fBdebops.filebeat\fP role:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
\-\-\-

\- name: Manage Filebeat service
  collections: [ \(aqdebops.debops\(aq, \(aqdebops.roles01\(aq,
                 \(aqdebops.roles02\(aq, \(aqdebops.roles03\(aq ]
  hosts: [ \(aqdebops_service_filebeat\(aq ]
  become: True

  environment: \(aq{{ inventory__environment | d({})
                   | combine(inventory__group_environment | d({}))
                   | combine(inventory__host_environment  | d({})) }}\(aq

  roles:

    \- role: keyring
      tags: [ \(aqrole::keyring\(aq, \(aqskip::keyring\(aq, \(aqrole::elastic_co\(aq ]
      keyring__dependent_apt_keys:
        \- \(aq{{ elastic_co__keyring__dependent_apt_keys }}\(aq

    \- role: apt_preferences
      tags: [ \(aqrole::apt_preferences\(aq, \(aqskip::apt_preferences\(aq ]
      apt_preferences__dependent_list:
        \- \(aq{{ elastic_co__apt_preferences__dependent_list }}\(aq

    \- role: elastic_co
      tags: [ \(aqrole::elastic_co\(aq, \(aqskip::elastic_co\(aq ]
      elastic_co__dependent_packages:
        \- \(aq{{ filebeat__elastic_co__dependent_packages }}\(aq

    \- role: filebeat
      tags: [ \(aqrole::filebeat\(aq, \(aqskip::filebeat\(aq ]

.ft P
.fi
.UNINDENT
.UNINDENT
.SS Ansible tags
.sp
You can use Ansible \fB\-\-tags\fP or \fB\-\-skip\-tags\fP parameters to limit what
tasks are performed during Ansible run. This can be used after host is first
configured to speed up playbook execution, when you are sure that most of the
configuration has not been changed.
.sp
Available role tags:
.INDENT 0.0
.TP
.B \fBrole::filebeat\fP
Main role tag, should be used in the playbook to execute all of the role
tasks as well as role dependencies.
.UNINDENT
.SH DEFAULT VARIABLE DETAILS
.sp
Some of the \fBdebops.filebeat\fP default variables have more extensive
configuration than simple strings or lists, here you can find documentation and
examples for them.
.SS filebeat__configuration
.sp
The \fBfilebeat__*_configuration\fP variables define the contents of the
\fB/etc/filebeat/filebeat.yml\fP configuration file. Each variable contains
a list of YAML dictionaries; each dictionary defines a part of the
configuration which gets merged together during Ansible execution.
.sp
You can read the \fI\%Filebeat configuration documentation\fP <\fBhttps://www.elastic.co/guide/en/beats/filebeat/current/configuring-howto-filebeat.html\fP> to learn more about
configuring Filebeat itself.
.SS Examples
.sp
Extend the default list of Filebeat inputs to include logs from Docker
containers (the configuration sections are not merged, but override each other
in order of appearance):
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
filebeat__configuration:

  \- name: \(aqfilebeat_inputs\(aq
    config:
      filebeat.inputs:
        \- type: \(aqlog\(aq
          enabled: True
          paths:
            \- \(aq/var/log/*.log\(aq
            \- \(aq/var/log/messages\(aq
        \- type: \(aqcontainer\(aq
          paths:
            \- \(aq/var/lib/docker/containers/*/*.log\(aq
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
Configure Filebeat to output its data to Elasticsearch on another host:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
filebeat__configuration:

  \- name: \(aqoutput_elasticsearch\(aq
    config:
      output.elasticsearch:
        hosts:
          \- \(aqelasticsearch.example.org:9200\(aq
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
Configure Elasticsearch output, but over an encrypted connection (requires
X\-Pack support) using certificates managed by the debops.pki role. The
access to the cluster is protected by a password, stored in the Filebeat
keystore:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
filebeat__configuration:

  \- name: \(aqoutput_elasticsearch\(aq
    config:
      output.elasticsearch:
        hosts:
          \- \(aqhttps://elasticsearch.example.org:9200\(aq
        ssl:
          certificate_authorities: \(aq/etc/pki/realms/domain/CA.crt\(aq
          certificate: \(aq/etc/pki/realms/domain/default.crt\(aq
          key: \(aq/etc/pki/realms/domain/default.key\(aq
        password: \(aq${ELASTIC_PASSWORD}\(aq
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
The \fBfilebeat__original_configuration\fP variable contains the
configuration that comes with the \fBfilebeat\fP APT package re\-implemented for
consumption by the role. The \fBfilebeat__default_configuration\fP variable
contains some additional configuration enabled by default.
.SS Syntax
.sp
Each configuration entry is a YAML dictionary with specific parameters:
.INDENT 0.0
.TP
.B \fBname\fP
Required. An identifier for a particular configuration entry, not used
otherwise. The configuration entries with the same \fBname\fP parameter
override each other.
.TP
.B \fBconfig\fP
Required. A dictionary which holds the Filebeat configuration written in
YAML. The \fBconfig\fP values from different configuration entries are merged
recursively using the \fBcombine\fP Ansible filter into a final YAML document.
.sp
YAML keys can be specified in a tree\-like structure:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
output:
  elasticsearch:
    hosts:
      \- \(aqelasticsearch.example.org:9200\(aq
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
Or, they can be defined on a single line, separated by dots:
.INDENT 7.0
.INDENT 3.5
.sp
.nf
.ft C
output.elasticsearch.hosts: [ \(aqelasticsearch.example.org:9200\(aq ]
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
The \fBcombine\fP Ansible filter does not automatically expand the dot\-notation
to a tree\-like structure. Therefore it\(aqs important to use the same style
thruought the configuration, otherwise the final YAML document will have
duplicate entries.
.TP
.B \fBstate\fP
Optional. If not specified or \fBpresent\fP, the configuration will be included
in the generated \fB/etc/filebeat/filebeat.yml\fP configuration file. if
\fBabsent\fP, the configuration will not be included in the final file. If
\fBignore\fP, the entry will not be evaluated by Ansible during execution.
.UNINDENT
.SS filebeat__snippets
.sp
The \fBfilebeat__*_snippets\fP variables define the placement and contents of
various \fB*.yml\fP files under the \fB/etc/filebeat/\fP directory. The
files can include Filebeat configuration in YAML format.
.SS Examples
.sp
Define an input source for logs generated by a custom application:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
filebeat__snippets:

  \- name: \(aqinputs.d/application.yml\(aq
    config:
      type: \(aqlog\(aq
      enabled: True
      paths: [ \(aq/var/log/application/*.log\(aq ]
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
Add configuration for a built\-in Filebeat module:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
filebeat__snippets:

  \- name: \(aqmodules.d/auditd.yml\(aq
    config:
      \- module: \(aqauditd\(aq
        log:
          enabled: True
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
You can find more example configurations in the
\fBfilebeat__default_snippets\fP variable.
.SS Syntax
.sp
Each configuration entry is a YAML dictionary with specific parameters:
.INDENT 0.0
.TP
.B \fBname\fP
Required. Path of the configuration file, relative to the
\fB/etc/filebeat/\fP directory, with all needed subdirectories. The
\fBname\fP parameter is also used as an identifier, entries with the same
\fBname\fP parameter override each other in order of appearance.
.sp
Role by default configures two subdirectories for input (\fBinput.d/\fP)
and Filebeat modules (\fBmodules.d/\fP) configuration. Don\(aqt use the
\fBfilebeat.yml\fP as the filename, otherwise you will override the main
configuration file.
.TP
.B \fBconfig\fP
Required. A dictionary which holds the Filebeat configuration written in
YAML. The value can either be a dictionary or a list of dictionaries, the
result in the generated file will always be a list.
.TP
.B \fBstate\fP
Optional. If not specified or \fBpresent\fP, the configuration file will be
generated.  If \fBabsent\fP, the configuration file will not be generated, and
an existing file will be removed. If \fBignore\fP, the entry will not be
evaluated by Ansible during execution.
.TP
.B \fBcomment\fP
Optional. Comment to be included at the top of the generated file.
.TP
.B \fBmode\fP
Optional. Specify the filesystem permissions of the generated file. If not
specified, \fB0600\fP will be used by default.
.UNINDENT
.SS filebeat__keys
.sp
The \fBfilebeat__*_keys\fP variables define the contents of the \fI\%Filebeat
keystore\fP <\fBhttps://www.elastic.co/guide/en/beats/filebeat/current/keystore.html\fP> used to keep confidental data like passwords or access tokens. The
keys can be referenced in the Filebeat configuration files using the
\fB${secret_key}\fP syntax.
.SS Examples
.sp
Add an Elasticsearch password used for access over a secure connection. The
password is retrieved from the \fBsecret/\fP directory on the Ansible
Controller, managed by the debops.secret Ansible role:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
filebeat__keys:

  \- ELASTIC_PASSWORD: \(aq{{ lookup("file", secret + "/elastic\-stack/elastic/password") }}\(aq
  \- KIBANA_PASSWORD:  \(aq{{ lookup("file", secret + "/elastic\-stack/kibana/password") }}\(aq
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
Update an existing key with new content (presence of the \fBforce\fP parameter
will update the key on each Ansible run):
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
filebeat__keys:

  \- name: \(aqELASTIC_PASSWORD\(aq
    value: \(aqnew\-elasticsearch\-password\(aq
    force: True
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
Remove a key from the Filebeat keystore:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
filebeat__keys:

  \- name: \(aqELASTIC_PASSWORD\(aq
    state: \(aqabsent\(aq
.ft P
.fi
.UNINDENT
.UNINDENT
.SS Syntax
.sp
Each key entry is defined by a YAML dictionary. The keys can be defined using
a simple format, with dictionary key being the secret key name, and its value
being the secret value. In this case you should avoid the \fBname\fP or \fBvalue\fP
as the secret keys.
.sp
Alternatively, secret keys can be defined using YAML dictionaries with specific
parameters:
.INDENT 0.0
.TP
.B \fBname\fP
Required. Name of the secret key to store in the Filebeat keystore.
.TP
.B \fBvalue\fP
Optional. A string with the value which should be stored under a given key.
.TP
.B \fBstate\fP
Optional. If not specified or \fBpresent\fP, the key will be inserted into the
keystore. If \fBabsent\fP, the key will be removed from the keystore.
.TP
.B \fBforce\fP
Optional, boolean. If present and \fBTrue\fP, the specified key will be updated
in the keystore.
.UNINDENT
.SH AUTHOR
Maciej Delmanowski
.SH COPYRIGHT
2014-2021, Maciej Delmanowski, Nick Janetakis, Robin Schneider and others
.\" Generated by docutils manpage writer.
.
