.\" Man page generated from reStructuredText.
.
.TH "DEBOPS.MACHINE" "5" "Mar 04, 2021" "v2.2.1" "DebOps"
.SH NAME
debops.machine \- Manage local machine information and MOTD
.
.nr rst2man-indent-level 0
.
.de1 rstReportMargin
\\$1 \\n[an-margin]
level \\n[rst2man-indent-level]
level margin: \\n[rst2man-indent\\n[rst2man-indent-level]]
-
\\n[rst2man-indent0]
\\n[rst2man-indent1]
\\n[rst2man-indent2]
..
.de1 INDENT
.\" .rstReportMargin pre:
. RS \\$1
. nr rst2man-indent\\n[rst2man-indent-level] \\n[an-margin]
. nr rst2man-indent-level +1
.\" .rstReportMargin post:
..
.de UNINDENT
. RE
.\" indent \\n[an-margin]
.\" old: \\n[rst2man-indent\\n[rst2man-indent-level]]
.nr rst2man-indent-level -1
.\" new: \\n[rst2man-indent\\n[rst2man-indent-level]]
.in \\n[rst2man-indent\\n[rst2man-indent-level]]u
..
.SH SYNOPSIS
.sp
\fBdebops service/machine\fP [\fB\-\-limit\fP \fIgroup,host,\fP\&...] [\fB\-\-diff\fP] [\fB\-\-check\fP] [\fB\-\-tags\fP \fItag1,tag2,\fP\&...] [\fB\-\-skip\-tags\fP \fItag1,tag2,\fP\&...] [<\fBansible\-playbook\fP options>] ...
.SH DESCRIPTION
.sp
The \fBdebops.machine\fP Ansible role manages basic information about a given
host located in the \fB/etc/machine\-info\fP configuration file, as well as
static and dynamic Message Of The Day (MOTD) shown after login, and the
contents of the \fB/etc/issue\fP file displayed on the \fI\%system console\fP <\fBhttps://en.wikipedia.org/wiki/System_console\fP>\&.
.SH GETTING STARTED
.SS Default configuration
.sp
By default, the role will remove an existing \fB/etc/motd\fP file to move the
original Debian/Ubuntu MOTD out of the way. This can be controlled using the
\fBmachine__etc_motd_state\fP variable. The original version of the file is
maintained by the \fBbase\-files\fP package and can be found in the
\fB/usr/share/base\-files/motd\fP file.
.sp
You can use the \fB/etc/motd.tail\fP file to include manual text in the
dynamic MOTD. Alternatively, you can put a custom script in the
\fB/etc/update\-motd.d/\fP directory.
.sp
You can use the debops.resources Ansible role to install multiple custom
scripts in the \fB/etc/update\-motd.d/\fP directory at once by copying them
from the \fBresources/\fP subdirectory on the Ansible Controller.
.SS Ansible local facts
.sp
The \fBdebops.machine\fP role provides a set of Ansible local facts available in
the \fBansible_local.machine.*\fP hierarchy. They will contain contents of the
\fB/etc/machine\-info\fP variables, so that they could be used by other
Ansible roles when configured.
.SS Example inventory
.sp
The \fBdebops.machine\fP role is included by default in the \fBcommon.yml\fP DebOps
playbook; you don\(aqt need to add hosts to any Ansible groups to enable it.
.SS Example playbook
.sp
If you are using this role without DebOps, here\(aqs an example Ansible playbook
that uses the \fBdebops.machine\fP role:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
\-\-\-

\- name: Manage local machine information
  collections: [ \(aqdebops.debops\(aq, \(aqdebops.roles01\(aq,
                 \(aqdebops.roles02\(aq, \(aqdebops.roles03\(aq ]
  hosts: [ \(aqdebops_all_hosts\(aq, \(aqdebops_service_machine\(aq ]
  become: True

  environment: \(aq{{ inventory__environment | d({})
                   | combine(inventory__group_environment | d({}))
                   | combine(inventory__host_environment  | d({})) }}\(aq

  roles:

    \- role: machine
      tags: [ \(aqrole::machine\(aq, \(aqskip::machine\(aq ]

.ft P
.fi
.UNINDENT
.UNINDENT
.SS Ansible tags
.sp
You can use Ansible \fB\-\-tags\fP or \fB\-\-skip\-tags\fP parameters to limit what
tasks are performed during Ansible run. This can be used after a host was first
configured to speed up playbook execution, when you are sure that most of the
configuration is already in the desired state.
.sp
Available role tags:
.INDENT 0.0
.TP
.B \fBrole::machine\fP
Main role tag, should be used in the playbook to execute all of the role
tasks as well as role dependencies.
.UNINDENT
.SH DEFAULT VARIABLE DETAILS
.sp
Some of the \fBdebops.machine\fP default variables have more extensive
configuration than simple strings or lists, here you can find documentation and
examples for them.
.SS machine__motd_scripts
.sp
This variable is a list which can be used to manage scripts in the
\fB/etc/update\-motd.d/\fP directory, used to generate the dynamic Message Of
The Day.
.sp
Each list entry is a YAML dictionary with specific parameters:
.INDENT 0.0
.TP
.B \fBname\fP
Required. Name of a given entry, used as a handle to merge multiple entries
together. It\(aqs also used in an autogenerated filename of the script.
.TP
.B \fBweight\fP
Optional. Modify the base "weight" of a given script to reorder its output in
the resulting dynamic MOTD. The base weight used by the role is \fB0\fP, you
can use positive or negative numbers to reorder the scripts. The filename
format uses 2 digits to define the weight, therefore you should use small
range of weights, otherwise weird filenames resulting in unwanted order might
be generated.
.TP
.B \fBfilename\fP
Optional. Define a static filename of the script. This filename won\(aqt be
affected by the \fBname\fP and \fBweight\fP parameters. It\(aqs usually used for
scripts provided by Debian packages to aid in \fBdpkg\fP
diversion/reversion.
.TP
.B \fBsrc\fP
Optional, conflicts with \fBcontent\fP\&. Path to a script which should be
installed in the \fB/etc/update\-motd.d/\fP directory with a given name. By
default the path is relative to the \fBfiles/\fP directory of the
\fBdebops.machine\fP Ansible role.
.sp
The script output will be added to the dynamic MOTD. Remember that the script
is executed with \fBroot\fP privileges!
.TP
.B \fBcontent\fP
Optional, conflicts with \fBsrc\fP\&. YAML text block which contains a script to
be installed in the \fB/etc/update\-motd.d/\fP directory with a given name.
The script can contain Jinja templating which will be evaluated at Ansible
execution time.
.sp
The script output will be added to the dynamic MOTD. Remember that the script
is executed with \fBroot\fP privileges!
.TP
.B \fBdivert\fP
Optional, boolean. If \fBTrue\fP, the script managed by this entry will be
automatically diverted/reverted as necessary. This is useful to move the
files included in the APT packages aside, so that the package manager can
still update the packages without issues.
.sp
The diverted scripts will have a \fB\&.disabled\fP extension and their output
will not be included in the dynamic MOTD.
.TP
.B \fBstate\fP
Optional. Define the state of a particular script. If multiple list entries
define a script state, the last one wins. Recognized states:
.INDENT 7.0
.IP \(bu 2
not specified or \fBpresent\fP: the script will be installed in the
\fB/etc/update\-motd.d/\fP directory. If an entry has a \fBdivert: True\fP
parameter, existing script will be diverted.
.IP \(bu 2
\fBabsent\fP: the specified script will be removed. Diverted scripts will be
reverted to their previous location, but otherwise will not be removed.
.IP \(bu 2
\fBinit\fP: the configuration of a given entry will be "initiated", but
otherwise the entry will not change anything on the host. This can be used
to prepare an entry and activate it later conditionally.
.IP \(bu 2
\fBignore\fP: the given configuration entry will be ignored by the role. This
can be used to conditionally activate or skip entries.
.IP \(bu 2
\fBdivert\fP: if a given entry has the \fBdivert: True\fP parameter, the
specified script will be diverted and effectively disabled. The role will
not generate a replacement script. This state can be used to disable
scripts installed by APT packages without providing replacements.
.IP \(bu 2
\fBrevert\fP: if a given entry has the \fBdivert: True\fP parameter, the
specified script will be reverted to its original state.
.UNINDENT
.UNINDENT
.SS Examples
.sp
Include a random fortune in the dynamic MOTD using the \fBfortune\fP
output, if it\(aqs installed:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
machine__motd_scripts:

  \- name: \(aqfortune\(aq
    weight: 95
    content: |
      #!/bin/sh
      . /etc/default/locale
      export LANG
      export PATH="/usr/local/games:/usr/games:$PATH"
      if [ \-x /usr/games/fortune ] ; then
          /usr/games/fortune \-s
      fi
    state: \(aqpresent\(aq
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
Include a random fortune in the dynamic MOTD using a script provided by the
role:
.INDENT 0.0
.INDENT 3.5
.sp
.nf
.ft C
machine__motd_scripts:

  \- name: \(aqfortune\(aq
    weight: 95
    src: \(aqetc/update\-motd.d/fortune\(aq
.ft P
.fi
.UNINDENT
.UNINDENT
.sp
\fBNOTE:\fP
.INDENT 0.0
.INDENT 3.5
Name of this role was based on the \fB/etc/machine\-info\fP
configuration file, and is loosely connected to the concept of the
"Machine" defined in the \fI\%Site Reliability Engineering\fP <\fBhttps://landing.google.com/sre/book/chapters/production-environment.html\fP> book.
.UNINDENT
.UNINDENT
.SH AUTHOR
Maciej Delmanowski
.SH COPYRIGHT
2014-2021, Maciej Delmanowski, Nick Janetakis, Robin Schneider and others
.\" Generated by docutils manpage writer.
.
