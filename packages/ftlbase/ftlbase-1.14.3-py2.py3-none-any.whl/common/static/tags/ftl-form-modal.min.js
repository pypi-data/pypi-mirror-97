riot.tag2("ftl-form-modal",'<div class="modal" ref="editModal" role="dialog" aria-labelledby="ftl-form-modal" method="post" show="{opts.modal.isvisible}"> <div class="modal-dialog modal-lg" role="document"> <div class="modal-content"> <form ref="modalForm" class="form-group" method="POST" onsubmit="{submit}"> <div class="modal-header"> <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button> <h4 class="modal-title" ref="ftlmodaltitle">{opts.data.modaltitle}</h4> </div> <div class="modal-body"> <div ref="ftlmodalbody"></div> </div> <div class="modal-footer"> <input ref="contextMenuID" type="hidden" value=""> <input ref="contextMenuParent" type="hidden" value=""> <input ref="pk" type="hidden" riot-value="{opts.data.pk}"> <button each="{buttons}" type="{type}" name="{nome}" class="button {\'btn btn-\' + cls} btn-sm" onclick="{menuclick}"> {text} </button> </div> </form> </div> </div> </div> <ul ref="contextMenu" class="dropdown-menu" role="menu" style="display:none"> <li><a tabindex="-1">{opts.data.modaltitle}</a></li> <li class="divider"></li> <li><a ref="contextCreate" data-action="1" tabindex="-1" href="#">Criar Novo Registro</a></li> <li><a ref="contextAlter" data-action="2" tabindex="-1" href="#">Alterar</a></li> <li><a ref="contextDelete" data-action="3" tabindex="-1" href="#">Excluir</a></li> </ul>',"","",(function(e){self=this,self.buttons=[],self.getMenuPosition=(e,t,o)=>{var l=$(window)[t](),a=$(window)[o](),n=$(self.refs.contextMenu)[t](),s=e+a;return e+n>l&&n<e&&(s-=n),s},this.menuclick=function(e){return"cancel"===e.target.name&&e.preventDefault(),$(self.refs.editModal).modal("toggle"),!1}.bind(this),this.popitupModal=function(e,t){if(self.refs.contextMenuID.value=e,self.refs.contextMenu.style.display="none",void 0===t)return!1;self.buttons=[],"1"===t||"2"===t?self.buttons.push({type:"submit",nome:"save",cls:"primary",text:"Salvar"}):self.buttons.push({type:"submit",nome:"DELETE",cls:"danger",text:"Confirmar exclusÃ£o do registro"}),self.buttons.push({type:"button",nome:"cancel",cls:"default",text:"Cancelar"});var o=self.opts.data.acaoURL+e+"/"+t+"/"+self.opts.data.pk+"/";return $(self.refs.modalForm).attr("action",o),$(self.refs.ftlmodalbody).load(o,null,(function(e,t,o){200!==o.status?alert("Status: >"+t+"< \nxhr.status = >"+o.status+"<"):configuraPagina()})),self.update(),$(self.refs.editModal).modal("toggle"),!1}.bind(this),self.on("mount",()=>{e.modal||(e.modal={isvisible:!1,contextmenu:!1,idtree:"tree1"}),e.data||(e.data={pk:1,action:1,acaoURL:"/finan/contaContabil/",updateParent:"",modaltitle:"Modal Title"}),self.refs.ftlmodaltitle.innerHTML=e.data.modaltitle,self.refs.pk=e.data.pk,self.tree=$("#"+self.opts.modal.idtree),self.tree.tree({dragAndDrop:!0,autoOpen:!0,autoEscape:!1,slide:!1,onLoading:function(e,t,o){var l=$("body");e?l.addClass("loading"):l.removeClass("loading")},onLoadFailed:function(e){}}),self.tree.bind("tree.move",(function(e){var t;e.preventDefault(),"inside"===e.move_info.position&&(t=e.move_info.target_node.id),"after"===e.move_info.position&&(t=e.move_info.target_node.parent.id),t!==e.move_info.moved_node.parent.id&&$.post(self.opts.data.updateParent,{no:e.move_info.moved_node.id,pai:t},(function(t,o,l){200!==l.status&&alert("Status: >"+o+"< \nxhr.status = >"+l.status+"<"),self.trigger("reloadTree",e.move_info.moved_node.id)}))})),self.tree.bind("tree.dblclick",(function(e){e.preventDefault();var t=e.node;self.refs.contextMenuID.value=t.id,self.popitupModal(t.id,"2")})),self.tree.bind("tree.contextmenu",(function(e){var t=e.node;self.tree.tree("selectNode",t),self.refs.contextMenuID.value=t.id;var o=t.getPreviousNode();o&&(self.refs.contextMenuParent.value=o.id),t.children.length>0?self.refs.contextDelete.style.display="none":self.refs.contextDelete.style.display="block",$(self.refs.contextMenu).show().css({position:"absolute",left:self.getMenuPosition(e.click_event.clientX,"width","scrollLeft"),top:self.getMenuPosition(e.click_event.clientY,"height","scrollTop")}).off("click").on("click","a",(function(t){t.preventDefault(),self.popitupModal(e.node.id,t.target.dataset.action)}))}))}),self.close=()=>{e.modal.isvisible=!1,self.trigger("close")},self.submit=e=>{e.preventDefault();var t=$(self.refs.modalForm);t.find(":disabled").removeProp("disabled");var o=t.serialize();return $.ajax({type:t.attr("method"),url:t.attr("action"),data:o,success:function(t){e.preventDefault();var o=self.refs.contextMenuID.value;null==o&&(o=self.refs.contextMenuParent.value),self.trigger("reloadTree",o)},error:function(e){console.log("Something went wrong: >"+e+"<")}}),!1},self.on("reloadTree",e=>{self.tree.tree("reload",(function(){var t=self.tree.tree("getNodeById",e);self.tree.tree("selectNode",t),self.tree.tree("openNode",t,!1)}))})}));