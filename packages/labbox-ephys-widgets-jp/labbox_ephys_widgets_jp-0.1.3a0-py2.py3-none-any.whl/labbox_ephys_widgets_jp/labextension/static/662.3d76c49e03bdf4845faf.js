(self.webpackChunklabbox_ephys_widgets_jp=self.webpackChunklabbox_ephys_widgets_jp||[]).push([[662],{50977:(e,t,s)=>{"use strict";s.d(t,{Zo:()=>h,zy:()=>i,lG:()=>l});const n=[];class o{constructor({maxSimultaneous:e,method:t}){this._activeSlots={},this._numActiveSlots=0,this._lastSlotId=-1,this._pendingRequestCallbacks=[],this._paused=!1,this._resumeCallbacks=[],this._maxSimultaneous=e,this._method=t||"queue",n.push(this)}requestSlot(){return e=this,t=void 0,n=function*(){return this._paused?new Promise(((e,t)=>{this._resumeCallbacks.push((()=>{this.requestSlot().then(e).catch(t)}))})):this._numActiveSlots<this._maxSimultaneous?this._createNewSlot():new Promise(((e,t)=>{this._pendingRequestCallbacks.push((t=>{e(t)}))}))},new((s=void 0)||(s=Promise))((function(o,i){function r(e){try{c(n.next(e))}catch(e){i(e)}}function a(e){try{c(n.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof s?t:new s((function(e){e(t)}))).then(r,a)}c((n=n.apply(e,t||[])).next())}));var e,t,s,n}isPaused(){return this._paused}pause(){this._paused||(this._paused=!0,this._resumeCallbacks=[])}resume(){this._paused&&(this._paused=!1,this._resumeCallbacks.forEach((e=>{e()})))}_createNewSlot(){const e=this._lastSlotId+1;return this._lastSlotId=e,this._numActiveSlots++,this._activeSlots[e]={slotId:e,complete:()=>{this._numActiveSlots--,delete this._activeSlots[e],this._update()}},this._activeSlots[e]}_update(){for(;this._pendingRequestCallbacks.length>0&&this._numActiveSlots<this._maxSimultaneous;){let e;if("queue"===this._method)e=this._pendingRequestCallbacks.shift();else{if("stack"!==this._method)throw Error(`Unexpected method in calculation pool: ${this._method}`);e=this._pendingRequestCallbacks.pop()}if(!e)throw Error("unexpected");e(this._createNewSlot())}}}const i=({maxSimultaneous:e,method:t})=>new o({maxSimultaneous:e,method:t});var r=s(56271);const a={jobId:null,functionName:"",kwargs:{},opts:{},clientJobId:"",result:null,runtime_info:{},error_message:null,status:"pending",timestampStarted:0,timestampFinished:null,clientCancelled:!1,wait:()=>{return e=void 0,t=void 0,n=function*(){},new((s=void 0)||(s=Promise))((function(o,i){function r(e){try{c(n.next(e))}catch(e){i(e)}}function a(e){try{c(n.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof s?t:new s((function(e){e(t)}))).then(r,a)}c((n=n.apply(e,t||[])).next())}));var e,t,s,n},cancel:()=>{}},c={createHitherJob:(e,t,s)=>a,getHitherJobs:()=>[]},h=s.n(r)().createContext(c);function u(e,t){if(e===t)return!0;if(Array.isArray(e)){if(!Array.isArray(t))return!1;if(e.length!==t.length)return!1;for(let s=0;s<e.length;s++)if(!u(e[s],t[s]))return!1;return!0}if("object"==typeof e){if("object"!=typeof t)return!1;for(let s in e){if(!(s in t))return!1;if(!u(e[s],t[s]))return!1}for(let s in t)if(!(s in e))return!1;return!0}return!1}const l=(e,t,s)=>{var n;const o=(0,r.useContext)(h),[i,c]=(0,r.useState)({status:"pending",functionName:"",hitherJobOpts:{},functionArgs:{},job:null});if(!e)return{result:void 0,job:a};if(e!==i.functionName||!u(t,i.functionArgs)||!u(s,i.hitherJobOpts)){const n=o.createHitherJob(e,t,s);return c({status:"running",functionName:e,functionArgs:t,hitherJobOpts:s,job:n}),n.wait().then((()=>{n.clientCancelled||c({status:"finished",functionName:e,functionArgs:t,hitherJobOpts:s,job:n})})).catch((o=>{n.clientCancelled||c({status:"error",functionName:e,functionArgs:t,hitherJobOpts:s,job:n})})),{result:void 0,job:n}}if(!i.job)throw Error("Unexpected: job is not defined");let l={result:void 0,job:i.job};switch(i.status){case"finished":l.result=null===(n=i.job)||void 0===n?void 0:n.result}return l}},80662:(e,t,s)=>{"use strict";s.r(t),s.d(t,{HitherContext:()=>c.Zo,LabboxProvider:()=>v,LabboxProviderContext:()=>j,createCalculationPool:()=>c.zy,createExtensionContext:()=>k,initializeHitherInterface:()=>m,useHitherJob:()=>c.lG,useLabboxPlugins:()=>N,usePlugins:()=>J,useSubfeed:()=>S});var n=s(56271),o=s.n(n),i=s(78991),r=s.n(i);const a=e=>new Promise((t=>setTimeout(t,e)));var c=s(50977),h=s(81410),u=s.n(h),l=function(e,t,s,n){return new(s||(s=Promise))((function(o,i){function r(e){try{c(n.next(e))}catch(e){i(e)}}function a(e){try{c(n.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof s?t:new s((function(e){e(t)}))).then(r,a)}c((n=n.apply(e,t||[])).next())}))};const d=(0,c.zy)({maxSimultaneous:20}),b=e=>{if("object"==typeof e){if(Array.isArray(e))return e.map((e=>b(e)));if("ndarray"===e._type){const t=e.shape,s=e.dtype,n=e.data_b64,o=_(n);if("float32"===s)return f(new Float32Array(o),t);if("int32"===s)return f(new Int32Array(o),t);if("int16"===s)return f(new Int16Array(o),t);throw Error(`Datatype not yet implemented for ndarray: ${s}`)}{const t={};for(let s in e)t[s]=b(e[s]);return t}}return e},f=(e,t)=>{if(1===t.length){if(t[0]!==e.length)throw Error("Unexpected length of array");return Array.from(e)}if(2===t.length){const s=t[0],n=t[1];if(s*n!==e.length)throw Error("Unexpected length of array");const o=[];for(let t=0;t<s;t++)o.push(Array.from(e.slice(t*n,(t+1)*n)));return o}throw Error("Not yet implemented")},_=e=>{for(var t=window.atob(e),s=t.length,n=new Uint8Array(s),o=0;o<s;o++)n[o]=t.charCodeAt(o);return n.buffer};function g(e){for(var t="",s="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",n=0;n<e;n++)t+=s.charAt(Math.floor(Math.random()*s.length));return t}const m=e=>{const t={hitherClientJobCache:{},hitherJobs:{},runningJobIds:{},sendMessage:e=>{throw Error("sendMessage not registered for hither interface.")}};class s{constructor(e){this._object={functionName:e.functionName,kwargs:e.kwargs,opts:e.opts,clientJobId:g(10)+"-client",jobId:null,result:null,runtime_info:null,error_message:null,status:"pending",timestampStarted:Number(new Date),timestampFinished:null,clientCancelled:!1,wait:()=>l(this,void 0,void 0,(function*(){return yield this.wait()})),cancel:()=>{this.cancel()}},this._onFinishedCallbacks=[],this._onErrorCallbacks=[]}object(){return this._object}wait(){return l(this,void 0,void 0,(function*(){return new Promise(((e,t)=>{this.onFinished((t=>{e(t)})),this.onError((e=>{t(e)}))}))}))}clientJobId(){return this._object.clientJobId}cancel(){this._object.jobId?t.sendMessage({type:"hitherCancelJob",job_id:this._object.jobId}):console.warn("Cannot cancel job that has not yet been created on the server.")}onFinished(e){this._onFinishedCallbacks.push(e),"finished"===this._object.status&&e(this._object.result)}onError(e){this._onErrorCallbacks.push(e),"error"===this._object.status&&e(new Error(this._object.error_message))}_handleHitherJobCreated(e){this._object.jobId=e.jobId,"pending"===this._object.status&&(this._object.status="running",t.runningJobIds[this._object.jobId]=!0)}_handleHitherJobError(e){this._object.timestampFinished=Number(new Date),this._object.status="error",this._object.error_message=e.errorString,this._object.runtime_info=e.runtime_info,this._onErrorCallbacks.forEach((e=>e(new Error(this._object.error_message)))),this._object.jobId&&this._object.jobId in t.runningJobIds&&delete t.runningJobIds[this._object.jobId]}_handleHitherJobFinished(e){this._object.timestampFinished=Number(new Date),this._object.result=b(e.result),this._object.runtime_info=e.runtime_info,this._object.status="finished",this._object.jobId&&this._object.jobId in t.runningJobIds&&delete t.runningJobIds[this._object.jobId],this._onFinishedCallbacks.forEach((e=>e(this._object.result)))}}return{_registerSendMessage:e=>{t.sendMessage=e},createHitherJob:(e,n,o)=>{const i=u()({functionName:e,kwargs:n,opts:{useClientCache:o.useClientCache}});if(o.useClientCache){const e=t.hitherClientJobCache[i];if(e)return e.object()}const r=new s({functionName:e,kwargs:n,opts:o});return t.hitherJobs[r._object.clientJobId]=r,o.useClientCache&&(t.hitherClientJobCache[i]=r),(o.calculationPool||d).requestSlot().then((({complete:e})=>{r.onError((()=>{e()})),r.onFinished((()=>{e()})),t.sendMessage({type:"hitherCreateJob",functionName:r._object.functionName,kwargs:r._object.kwargs,clientJobId:r._object.clientJobId})})),r.object()},handleHitherJobFinished:s=>{const n=t.hitherJobs[s.job_id]||t.hitherJobs[s.client_job_id];if(!n)return void console.warn(`job not found (handleHitherJobFinished): ${s.job_id} ${s.client_job_id}`);if(!n._object.jobId)return void console.warn("No _jobId for job");const o=s.result_sha1,i=e?`${e}/${o}`:void 0;i?r().get(i).then((e=>{n._handleHitherJobFinished({result:e.data,runtime_info:s.runtime_info})})).catch((e=>{n._handleHitherJobError({errorString:`Problem retrieving result: ${e.message}`,runtime_info:s.runtime_info})})):console.warn("Unable to get result because baseSha1Url is not defined")},handleHitherJobError:e=>{const s=t.hitherJobs[e.job_id]||t.hitherJobs[e.client_job_id];s?s._handleHitherJobError({errorString:e.error_message,runtime_info:e.runtime_info}):console.warn(`job not found (handleHitherJobError): ${e.job_id} ${e.client_job_id}`)},handleHitherJobCreated:e=>{if(!(e.client_job_id in t.hitherJobs))return void console.warn(`Unable to find job with clientJobId: ${e.client_job_id}.`);const s=t.hitherJobs[e.client_job_id];s._handleHitherJobCreated({jobId:e.job_id}),t.hitherJobs[e.job_id]=s,delete t.hitherJobs[s.clientJobId()]},getNumActiveJobs:()=>Object.values(t.hitherJobs).filter((e=>!["finished","error"].includes(e._object.status))).length,getHitherJobs:()=>Object.values(t.hitherJobs).map((e=>Object.assign({},e._object)))}};var p=function(e,t,s,n){return new(s||(s=Promise))((function(o,i){function r(e){try{c(n.next(e))}catch(e){i(e)}}function a(e){try{c(n.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof s?t:new s((function(e){e(t)}))).then(r,a)}c((n=n.apply(e,t||[])).next())}))};class w{constructor(){this.plugins=[]}registerPlugin(e){this.plugins.push(e)}}class C{constructor(e,t){this.apiConnection=e,this.baseFeedUrl=t,this._subfeedMessageRequests={},e.onMessage((e=>{if("subfeedMessageRequestResponse"===e.type){const t=e.requestId,s=e.numNewMessages;if(t in this._subfeedMessageRequests){const e=this._subfeedMessageRequests[t].callback;delete this._subfeedMessageRequests[t],e(s)}}}))}getMessages(e){return p(this,void 0,void 0,(function*(){const t=`${this.baseFeedUrl}/getMessages`,{feedUri:s,subfeedName:n,position:o,waitMsec:i}=e,a=(yield r().post(t,{feedUri:s,subfeedName:n,position:o,waitMsec:i})).data;return a.length>0?a:i>0?new Promise(((e,t)=>{let r=!1;const a={requestId:M(10),feedUri:s,subfeedName:n,position:o,waitMsec:i,callback:i=>{i>0?this.getMessages({feedUri:s,subfeedName:n,position:o,waitMsec:0}).then((t=>{r||(r=!0,e(t))})).catch((e=>{r||(r=!0,t(e))})):(r=!0,e([]))}};this._subfeedMessageRequests[a.requestId]=a,this.apiConnection.sendMessage({type:"subfeedMessageRequest",requestId:a.requestId,feedUri:a.feedUri,subfeedName:a.subfeedName,position:a.position,waitMsec:a.waitMsec}),setTimeout((()=>{r||(console.warn("Did not get the expected response for subfeed message request"),r=!0,e([]))}),i+2e3)})):[]}))}appendMessages(e){return p(this,void 0,void 0,(function*(){const{feedUri:t,subfeedName:s,messages:n}=e,o=`${this.baseFeedUrl}/appendMessages`;yield r().post(o,{feedUri:t,subfeedName:s,messages:n})}))}}const j=(0,n.createContext)({plugins:[],websocketStatus:"waiting",serverInfo:null,initialLoadComplete:!1,onReconnectWebsocket:()=>{}}),v=({children:e,extensionContext:t,apiConfig:s,status:i})=>{const r=(0,n.useMemo)((()=>new class{constructor(e){this.apiConfig=e,this._ws=null,this._isConnected=!1,this._onMessageCallbacks=[],this._onConnectCallbacks=[],this._onDisconnectCallbacks=[],this._isDisconnected=!1,this._queuedMessages=[],this._start(),this._connect()}_connect(){const e=this.apiConfig;if(e)if(e.jupyterMode){const t=e.jupyterModel;if(!t)throw Error("No jupyter model.");t.on("msg:custom",(e=>{for(const t of e)this._onMessageCallbacks.forEach((e=>e(t)))})),this._isConnected=!0,this._onConnectCallbacks.forEach((e=>e()))}else{const t=e.webSocketUrl;if(!t)throw Error("No webSocketUrl");const s=new WebSocket(t);this._ws=s,console.log(s),s.addEventListener("open",(()=>{this._isConnected=!0,this._isDisconnected=!1;const e=this._queuedMessages;this._queuedMessages=[];for(let t of e)this.sendMessage(t);this._onConnectCallbacks.forEach((e=>e()))})),s.addEventListener("message",(e=>{const t=JSON.parse(e.data);if(!Array.isArray(t))return console.warn(t),void console.warn("Error getting message, expected a list");console.info("INCOMING MESSAGES",t);for(const e of t)this._onMessageCallbacks.forEach((t=>t(e)))})),s.addEventListener("close",(()=>{console.warn("Websocket disconnected."),this._isConnected=!1,this._isDisconnected=!0,this._onDisconnectCallbacks.forEach((e=>e()))}))}}reconnect(){if(!this._isDisconnected)throw Error("Error: Cannot reconnect if not disconnected");this._connect()}onMessage(e){this._onMessageCallbacks.push(e)}onConnect(e){this._onConnectCallbacks.push(e),this._isConnected&&e()}onDisconnect(e){this._onDisconnectCallbacks.push(e),this._isDisconnected&&e()}isDisconnected(){return this._isDisconnected}isConnected(){return this._isConnected}sendMessage(e){const t=this.apiConfig;if(t)if(t.jupyterMode){const s=t.jupyterModel;if(!s)throw Error("No jupyter model.");console.info("OUTGOING MESSAGE (jupyter)",e),s.send(e,{})}else{if(!this._isConnected&&!this._isDisconnected)return void this._queuedMessages.push(e);if(!this._ws)throw Error("Unexpected: _ws is null");console.info("OUTGOING MESSAGE",e),this._ws.send(JSON.stringify(e))}}_start(){return e=this,t=void 0,n=function*(){for(;;)yield a(17e3),this._isDisconnected||this.sendMessage({type:"keepAlive"})},new((s=void 0)||(s=Promise))((function(o,i){function r(e){try{c(n.next(e))}catch(e){i(e)}}function a(e){try{c(n.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof s?t:new s((function(e){e(t)}))).then(r,a)}c((n=n.apply(e,t||[])).next())}));var e,t,s,n}}(s)),[s]),h=(e=>{const[t,s]=(0,n.useState)(e.isConnected()?"connected":e.isDisconnected()?"disconnected":"waiting");return(0,n.useEffect)((()=>{e.onConnect((()=>{s("connected")})),e.onDisconnect((()=>{s("disconnected")}))}),[e]),t})(r),u=(e=>{const[t,s]=(0,n.useState)(null);return(0,n.useEffect)((()=>{e.onMessage((e=>{"reportServerInfo"===e.type&&s(e.serverInfo)}))}),[e]),t})(r),l=(e=>{const[t,s]=(0,n.useState)(!1);return(0,n.useEffect)((()=>{e.onMessage((e=>{"reportInitialLoadComplete"===e.type&&s(!0)}))}),[e]),t})(r),d=((e,t,s)=>{const o=(0,n.useRef)({queuedHitherJobMessages:[]});return(0,n.useMemo)((()=>{const n=m(null==t?void 0:t.baseSha1Url);if(n._registerSendMessage((t=>{e.isDisconnected()?(o.current.queuedHitherJobMessages.push(t),"hitherCreateJob"===t.type&&o.current.queuedHitherJobMessages.push(t)):e.sendMessage(t)})),e.onMessage((e=>{const t=e.type;"hitherJobFinished"===t?n.handleHitherJobFinished(e):"hitherJobError"===t?n.handleHitherJobError(e):"hitherJobCreated"===t&&n.handleHitherJobCreated(e)})),e.onConnect((()=>{console.info("Connected to API server"),o.current.queuedHitherJobMessages.forEach((t=>{e.sendMessage(t)})),o.current.queuedHitherJobMessages=[]})),null==t?void 0:t.jupyterMode){let e=!1;const n=t.jupyterModel;if(!n)throw Error("No jupyter model.");n.on("msg:custom",(e=>{console.info("RECEIVED MESSAGES",e),e.length>0&&i(300)}));let o=200;const i=t=>{o=t,e?n.send({type:"iterate"},{}):(e=!0,p(void 0,void 0,void 0,(function*(){for(;e;)n.send({type:"iterate"},{}),yield y(o),o=Math.min(5e3,o+50),s&&!s.active&&(e=!1)})))};i(300)}return n}),[t,e])})(r,s,i),b=(0,n.useMemo)((()=>new C(r,null==s?void 0:s.baseFeedUrl)),[]),f=(0,n.useCallback)((()=>{r.reconnect()}),[r]),_=(0,n.useMemo)((()=>({plugins:t.plugins,websocketStatus:h,serverInfo:u,initialLoadComplete:l,subfeedManager:b,onReconnectWebsocket:f})),[t.plugins,h,u,l,f]);return o().createElement(j.Provider,{value:_},o().createElement(c.Zo.Provider,{value:d},e))};function M(e){for(var t="",s="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",n=0;n<e;n++)t+=s.charAt(Math.floor(Math.random()*s.length));return t}const y=e=>new Promise((t=>setTimeout(t,e))),J=()=>{const{plugins:e}=(0,n.useContext)(j);return e};class E{constructor(e,t,s){this.feedUri=e,this.subfeedName=t,this.subfeedManager=s,this.messages=[],this.loadedInitialMessages=!1,this._changeCallbacks=[],this._active=!1,this._active=!0,this._start()}onChange(e){this._changeCallbacks.push(e)}cleanup(){this._active=!1}_start(){return e=this,t=void 0,n=function*(){if(void 0!==this.feedUri&&void 0!==this.subfeedName)for(;this._active;){if(this.subfeedManager){const e=yield this.subfeedManager.getMessages({feedUri:this.feedUri,subfeedName:this.subfeedName,position:this.messages.length,waitMsec:12e3});e.length>0?(this.messages=[...this.messages,...e],this.loadedInitialMessages=!0,this._changeCallbacks.forEach((e=>e()))):this.loadedInitialMessages||(this.loadedInitialMessages=!0,this._changeCallbacks.forEach((e=>e())))}yield I(100)}},new((s=void 0)||(s=Promise))((function(o,i){function r(e){try{c(n.next(e))}catch(e){i(e)}}function a(e){try{c(n.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof s?t:new s((function(e){e(t)}))).then(r,a)}c((n=n.apply(e,t||[])).next())}));var e,t,s,n}}const I=e=>new Promise((t=>setTimeout(t,e))),S=e=>{const{feedUri:t,subfeedName:s,onMessages:o}=e,{subfeedManager:i}=(0,n.useContext)(j),[r,a]=(0,n.useState)([]),[c,h]=(0,n.useState)(!1);return(0,n.useEffect)((()=>{let e=0;const n=new E(t,s,i),r=()=>{e<n.messages.length&&(o&&o(n.messages.slice(e)),e=n.messages.length)};return n.onChange((()=>{a(n.messages),h(n.loadedInitialMessages),r()})),a(n.messages),h(n.loadedInitialMessages),r(),()=>{n.cleanup()}}),[i,t,s,o]),{messages:r,loadedInitialMessages:c,appendMessages:(0,n.useCallback)((e=>{void 0!==t&&void 0!==s&&(null==i||i.appendMessages({feedUri:t,subfeedName:s,messages:e}))}),[t,s,i])}},k=()=>new w,N=()=>{const{plugins:e}=(0,n.useContext)(j);return e}}}]);