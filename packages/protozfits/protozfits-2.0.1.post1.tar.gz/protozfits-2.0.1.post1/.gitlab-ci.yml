
variables:
  # make sure the CI system checks out the submodules
  GIT_SUBMODULE_STRATEGY: recursive


cpp:
  image: centos:centos7
  # make sure we only use the correct runner
  tags:
    - kubernetes

  before_script:
    # install build dependencies
    - yum install -y epel-release
    - yum install -y cmake3 make gcc gcc-c++ protobuf-devel zeromq-devel

  script:
    # build
    - cmake3 -S . -B build -DCMAKE_INSTALL_PREFIX=$HOME/.local/adh-apis -DPYTHON=OFF
    - cmake3 --build build -- -j 2
    - cmake3 --install build

    # run tests
    - cd build
    - ctest3 -V

python:
  # use ubuntu 20.04 to test with protobuf3
  image: ubuntu:20.04

  # make sure we only use the correct runner
  tags:
    - kubernetes

  variables:
    # needed to avoid interactive prompts during installation
    DEBIAN_FRONTEND: "noninteractive"

  before_script:
    # install build dependencies
    - apt update && apt install -y cmake build-essential libzmq3-dev libprotobuf-dev protobuf-compiler python3-dev python3-pip

    - python3 --version
    - python3 -m pip install -U --user pip

  script:
    - python3 -m pip install --user -e '.[all]'
    - python3 -m pytest -v python/protozfits
